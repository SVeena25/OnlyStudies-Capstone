{% extends 'base.html' %}
{% load static %}

{% block title %}OnlyStudies - Your Learning Platform{% endblock %}

{% block meta_description %}Discover comprehensive study materials, expert forums, blog posts, and exam preparation resources at OnlyStudies.{% endblock %}

{% block extra_css %}
    <!-- Custom CSS -->
    <link rel="stylesheet" href="{% static 'css/style.css' %}">
    <style>
        .hero-section {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 80px 20px;
            text-align: center;
            margin-bottom: 3rem;
            position: relative;
            overflow: hidden;
        }
        .hero-section::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: none;
            opacity: 1;
            z-index: 0;
        }
        .hero-content {
            position: relative;
            z-index: 1;
            max-width: 800px;
            margin: 0 auto;
        }
        .hero-section h1 {
            font-size: 3rem;
            font-weight: 700;
            margin-bottom: 1rem;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        }
        .hero-section p {
            font-size: 1.25rem;
            margin-bottom: 2rem;
            text-shadow: 1px 1px 2px rgba(0,0,0,0.3);
        }
        .hero-buttons {
            display: flex;
            gap: 1rem;
            justify-content: center;
            flex-wrap: wrap;
        }
        .hero-buttons .btn {
            padding: 10px 30px;
            font-weight: 600;
            border-radius: 5px;
        }
        @media (max-width: 768px) {
            .hero-section {
                padding: 50px 20px;
            }
            .hero-section h1 {
                font-size: 2rem;
            }
            .hero-section p {
                font-size: 1rem;
            }
        }
    </style>
{% endblock %}

{% block content %}
    <!-- Hero Section with Image -->
    <div class="hero-section">
        <div class="hero-content">
            <h1><i class="bi bi-book"></i> Welcome to OnlyStudies</h1>
            <p>Your comprehensive learning platform for exam preparation, interactive forums, and expert resources</p>
            <div class="hero-buttons">
                {% if user.is_authenticated %}
                    <a href="{% url 'blog_feed' %}" class="btn btn-light">
                        <i class="bi bi-newspaper me-2"></i>Read Blog
                    </a>
                    <a href="{% url 'forum' %}" class="btn btn-light">
                        <i class="bi bi-chat-dots me-2"></i>Join Forum
                    </a>
                    <a href="{% url 'tasks' %}" class="btn btn-light">
                        <i class="bi bi-check-circle me-2"></i>View Tasks
                    </a>
                {% else %}
                    <a href="{% url 'blog_feed' %}" class="btn btn-light">
                        <i class="bi bi-newspaper me-2"></i>Explore Blog
                    </a>
                    <a href="{% url 'forum' %}" class="btn btn-light">
                        <i class="bi bi-chat-dots me-2"></i>Browse Forum
                    </a>
                    <a href="{% url 'about' %}" class="btn btn-light">
                        <i class="bi bi-info-circle me-2"></i>About Us
                    </a>
                {% endif %}
            </div>
        </div>
    </div>

    <div class="container my-4">
        <!-- Blog & Notifications Section -->
        <section class="blog-notifications-section mb-5">
            <!-- Blog Feed & Notifications Row -->
            <div class="row g-3 mb-3">
                <!-- Blog Feed -->
                <div class="col-12 col-lg-8">
                    <div class="card h-100">
                        <div class="card-body">
                            <h5 class="card-title mb-3">Blog Feed</h5>
                            <div id="blog-feed-container">
                                <em class="text-muted">Loading blog posts...</em>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Notifications -->
                <div class="col-12 col-lg-4">
                    <div class="card h-100">
                        <div class="card-body">
                            <h5 class="card-title mb-3">Notifications</h5>
                            {% if user.is_authenticated %}
                                <div id="view-updates-alert" class="alert alert-info" role="alert">
                                    You have new updates available!
                                </div>
                            {% else %}
                                <div class="alert alert-warning" role="alert">
                                    <em>Log in to view your notifications</em>
                                </div>
                            {% endif %}
                            <ul class="list-unstyled notification-list" id="notifications-container">
                                <li class="notification-item"><em>Loading notifications...</em></li>
                            </ul>
                            {% if user.is_authenticated %}
                                <a id="view-updates-btn" href="{% url 'notifications' %}" class="btn btn-dark btn-sm w-100 mt-2">View Updates</a>
                            {% else %}
                                <a href="{% url 'login' %}" class="btn btn-dark btn-sm w-100 mt-2">Login to View Updates</a>
                            {% endif %}
                        </div>
                    </div>
                </div>
            </div>
        </section>

        <!-- Explore Exams Section -->
        <section class="exams-section mb-5">
            <h5 class="section-title mb-3">Explore Exams</h5>
            <!-- Explore Exams -->
            <div class="row g-3 mb-3">
                <!-- Exam 1 Card -->
                <div class="col-12 col-md-6 col-lg-4">
                    <div class="card exam-card h-100">
                        <div class="card-body">
                            <h6 class="card-title mb-2">Exam 1</h6>
                            <p class="exam-description">Prepare for your first exam with comprehensive study materials and practice tests.</p>
                            <a href="{% url 'apply_exam' 'exam-1' %}" class="btn btn-outline-dark btn-sm w-100">Apply for Exam 1</a>
                        </div>
                    </div>
                </div>

                <!-- Exam 2 Card -->
                <div class="col-12 col-md-6 col-lg-4">
                    <div class="card exam-card h-100">
                        <div class="card-body">
                            <h6 class="card-title mb-2">Exam 2</h6>
                            <p class="exam-description">Master advanced concepts with expert-led tutorials and interactive quizzes.</p>
                            <a href="{% url 'apply_exam' 'exam-2' %}" class="btn btn-outline-dark btn-sm w-100">Apply for Exam 2</a>
                        </div>
                    </div>
                </div>

                <!-- Exam 3 Card -->
                <div class="col-12 col-md-6 col-lg-4">
                    <div class="card exam-card h-100">
                        <div class="card-body">
                            <h6 class="card-title mb-2">Exam 3</h6>
                            <p class="exam-description">Achieve excellence with final revision modules and mock examinations.</p>
                            <a href="{% url 'apply_exam' 'exam-3' %}" class="btn btn-outline-dark btn-sm w-100">Apply for Exam 3</a>
                        </div>
                    </div>
                </div>
            </div>
        </section>

        <!-- Ask Question Section -->
        <section class="question-section mb-5">
            <!-- Ask Your Question -->
            <div class="row g-3 mb-3">
                <div class="col-12">
                    <div class="card" style="width: 854.667px; height: 200.667px; margin-left: auto; margin-right: auto;">
                        <div class="card-body text-center" style="background-color: #ffefd2;">
                            <h4 class="mb-3 fw-bold">
                                <i class="bi bi-chat-dots me-2"></i>Student Forum
                            </h4>
                            <div class="whiteWrapBox mb-3">
                                <div class="flx-box mA d-flex align-items-center gap-2 mb-2">
                                    <i class="bi bi-chat-left-text"></i>
                                    <strong>Anything you would want to ask experts?</strong>
                                </div>
                                <div id="askTxtBx" class="qst-txtar form-control" contenteditable="true" style="min-height: 60px; text-align: left; background-color: white;">Write here...</div>
                            </div>
                            <div class="d-flex gap-2 justify-content-center">
                                <a href="{% url 'forum' %}" class="btn btn-primary">
                                    <i class="bi bi-chat-dots me-2"></i>View Forum
                                </a>
                                <a href="{% url 'ask_question' %}" class="btn btn-success">
                                    <i class="bi bi-plus-circle me-2"></i>Ask Question
                                </a>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </section>
    </div>

{% endblock %}

{% block extra_js %}
<script>
    // Blog Feed loader
    function loadBlogFeed() {
        const blogPlaceholder = "{% static 'img/blog.png' %}";
        fetch('{% url "blog_feed_api" %}')
            .then(response => response.json())
            .then(data => {
                const blogContainer = document.getElementById('blog-feed-container');
                if (data.blogs && data.blogs.length > 0) {
                    const blog = data.blogs[0];
                    let html = '<div class="blog-post">';
                    const imgSrc = blog.featured_image || blogPlaceholder;
                    html += `<img src="${imgSrc}" alt="${blog.title}" class="img-fluid rounded mb-3" style="width: 100%; object-fit: cover; max-height: 300px;" width="1200" height="675" loading="lazy" decoding="async" onerror="this.onerror=null;this.src='${blogPlaceholder}'">`;
                    
                    html += `<h6>${blog.title}</h6>`;
                    html += `<small class="text-muted">By ${blog.author} â€¢ ${new Date(blog.created_at).toLocaleDateString()}</small>`;
                    html += `<p class="mt-2">${blog.content}...</p>`;
                    html += `<a href="/blog/${blog.slug}/" class="btn btn-sm btn-primary">Read More</a>`;
                    html += '</div>';
                    
                    blogContainer.innerHTML = html;
                } else {
                    blogContainer.innerHTML = '<em class="text-muted">No blog posts available</em>';
                }
            })
            .catch(error => {
                console.log('Blog feed error:', error);
                document.getElementById('blog-feed-container').innerHTML = '<em class="text-muted">Unable to load blog feed</em>';
            });
    }

    // Notifications loader (for authenticated users)
    function loadNotifications() {
        const notificationsContainer = document.getElementById('notifications-container');
        
        {% if user.is_authenticated %}
            fetch('{% url "notifications_api" %}')
                .then(response => {
                    if (!response.ok) {
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }
                    return response.json();
                })
                .then(data => {
                    if (data.notifications && data.notifications.length > 0) {
                        let html = '';
                        data.notifications.forEach(notification => {
                            html += `<li class="notification-item" title="${notification.message}">
                                <strong>${notification.title}</strong>
                                <small class="text-muted d-block">${new Date(notification.created_at).toLocaleDateString()}</small>
                            </li>`;
                        });
                        notificationsContainer.innerHTML = html;
                    } else {
                        notificationsContainer.innerHTML = '<li class="notification-item"><em>No new notifications</em></li>';
                    }
                })
                .catch(error => {
                    console.error('Notifications error:', error);
                    notificationsContainer.innerHTML = '<li class="notification-item"><em>Unable to load notifications</em></li>';
                });
        {% else %}
            notificationsContainer.innerHTML = '<li class="notification-item"><em>Log in to see your notifications</em></li>';
        {% endif %}
    }

    // Defer loads until browser is idle to avoid blocking main thread
    if ('requestIdleCallback' in window) {
        requestIdleCallback(() => {
            loadBlogFeed();
            loadNotifications();
        });
    } else {
        // Fallback for browsers without requestIdleCallback
        setTimeout(() => {
            loadBlogFeed();
            loadNotifications();
        }, 100);
    }
</script>
{% endblock %}

