{% extends 'base.html' %}
{% load static %}

{% block title %}OnlyStudies - Your Learning Platform{% endblock %}

{% block extra_css %}
    <!-- Custom CSS -->
    <link rel="stylesheet" href="{% static 'css/style.css' %}">
{% endblock %}

{% block content %}
    <!-- Blog & Notifications Section -->
        <section class="blog-notifications-section">
            <!-- Blog Feed & Notifications Row -->
            <div class="row g-3 mb-3">
                <!-- Blog Feed -->
                <div class="col-12 col-lg-8">
                    <div class="card h-100">
                        <div class="card-body">
                            <h5 class="card-title mb-3">Blog Feed</h5>
                            <div id="blog-feed-container">
                                <em class="text-muted">Loading blog posts...</em>
                            </div>
                            <div style="max-height: 300px; overflow: hidden; margin-top: 1rem;">
                                <img src="{% static 'img/blog.png' %}" alt="Blog Feed" class="img-fluid rounded" style="width: 100%; object-fit: cover; object-position: top;">
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Notifications -->
                <div class="col-12 col-lg-4">
                    <div class="card h-100">
                        <div class="card-body">
                            <h5 class="card-title mb-3">Notifications</h5>
                            {% if user.is_authenticated %}
                                <div id="view-updates-alert" class="alert alert-info" role="alert">
                                    You have new updates available!
                                </div>
                            {% else %}
                                <div class="alert alert-warning" role="alert">
                                    <em>Log in to view your notifications</em>
                                </div>
                            {% endif %}
                            <ul class="list-unstyled notification-list" id="notifications-container">
                                <li class="notification-item"><em>Loading notifications...</em></li>
                            </ul>
                            {% if user.is_authenticated %}
                                <a id="view-updates-btn" href="{% url 'notifications' %}" class="btn btn-dark btn-sm w-100 mt-2">View Updates</a>
                            {% else %}
                                <a href="{% url 'login' %}" class="btn btn-dark btn-sm w-100 mt-2">Login to View Updates</a>
                            {% endif %}
                        </div>
                    </div>
                </div>
            </div>
        </section>

        <!-- Explore Exams Section -->
        <section class="exams-section">
            <h5 class="section-title mb-3">Explore Exams</h5>
            <!-- Explore Exams -->
            <div class="row g-3 mb-3">
                <!-- Exam 1 Card -->
                <div class="col-12 col-md-6 col-lg-4">
                    <div class="card exam-card h-100">
                        <div class="card-body">
                            <h6 class="card-title mb-2">Exam 1</h6>
                            <p class="exam-description">Prepare for your first exam with comprehensive study materials and practice tests.</p>
                            <a href="{% url 'apply_exam' 'exam-1' %}" class="btn btn-outline-dark btn-sm w-100">Apply</a>
                        </div>
                    </div>
                </div>

                <!-- Exam 2 Card -->
                <div class="col-12 col-md-6 col-lg-4">
                    <div class="card exam-card h-100">
                        <div class="card-body">
                            <h6 class="card-title mb-2">Exam 2</h6>
                            <p class="exam-description">Master advanced concepts with expert-led tutorials and interactive quizzes.</p>
                            <a href="{% url 'apply_exam' 'exam-2' %}" class="btn btn-outline-dark btn-sm w-100">Apply</a>
                        </div>
                    </div>
                </div>

                <!-- Exam 3 Card -->
                <div class="col-12 col-md-6 col-lg-4">
                    <div class="card exam-card h-100">
                        <div class="card-body">
                            <h6 class="card-title mb-2">Exam 3</h6>
                            <p class="exam-description">Achieve excellence with final revision modules and mock examinations.</p>
                            <a href="{% url 'apply_exam' 'exam-3' %}" class="btn btn-outline-dark btn-sm w-100">Apply</a>
                        </div>
                    </div>
                </div>
            </div>
        </section>

        <!-- Ask Question Section -->
        <section class="question-section">
            <!-- Ask Your Question -->
            <div class="row g-3 mb-3">
                <div class="col-12">
                    <div class="card" style="width: 854.667px; height: 200.667px; margin-left: auto; margin-right: auto;">
                        <div class="card-body text-center" style="background-color: #ffefd2;">
                            <h4 class="mb-3 fw-bold">
                                <i class="bi bi-chat-dots me-2"></i>Student Forum
                            </h4>
                            <div class="whiteWrapBox mb-3">
                                <div class="flx-box mA d-flex align-items-center gap-2 mb-2">
                                    <i class="bi bi-chat-left-text"></i>
                                    <strong>Anything you would want to ask experts?</strong>
                                </div>
                                <div id="askTxtBx" class="qst-txtar form-control" contenteditable="true" style="min-height: 60px; text-align: left; background-color: white;">Write here...</div>
                            </div>
                            <div class="d-flex gap-2 justify-content-center">
                                <a href="{% url 'forum' %}" class="btn btn-primary">
                                    <i class="bi bi-chat-dots me-2"></i>View Forum
                                </a>
                                <a href="{% url 'ask_question' %}" class="btn btn-success">
                                    <i class="bi bi-plus-circle me-2"></i>Ask Question
                                </a>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </section>

{% endblock %}

{% block extra_js %}
<script>
    // Blog Feed loader
    function loadBlogFeed() {
        fetch('{% url "blog_feed_api" %}')
            .then(response => response.json())
            .then(data => {
                const blogContainer = document.getElementById('blog-feed-container');
                if (data.blogs && data.blogs.length > 0) {
                    const blog = data.blogs[0];
                    let html = '<div class="blog-post">';
                    
                    if (blog.featured_image) {
                        html += `<img src="${blog.featured_image}" alt="${blog.title}" class="img-fluid rounded mb-3" style="width: 100%; object-fit: cover; max-height: 300px;">`;
                    }
                    
                    html += `<h6>${blog.title}</h6>`;
                    html += `<small class="text-muted">By ${blog.author} â€¢ ${new Date(blog.created_at).toLocaleDateString()}</small>`;
                    html += `<p class="mt-2">${blog.content}...</p>`;
                    html += `<a href="/blog/${blog.slug}/" class="btn btn-sm btn-primary">Read More</a>`;
                    html += '</div>';
                    
                    blogContainer.innerHTML = html;
                } else {
                    blogContainer.innerHTML = '<em class="text-muted">No blog posts available</em>';
                }
            })
            .catch(error => {
                console.log('Blog feed error:', error);
                document.getElementById('blog-feed-container').innerHTML = '<em class="text-muted">Unable to load blog feed</em>';
            });
    }

    // Notifications loader (for authenticated users)
    function loadNotifications() {
        const notificationsContainer = document.getElementById('notifications-container');
        
        {% if user.is_authenticated %}
            fetch('{% url "notifications_api" %}')
                .then(response => {
                    if (!response.ok) {
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }
                    return response.json();
                })
                .then(data => {
                    if (data.notifications && data.notifications.length > 0) {
                        let html = '';
                        data.notifications.forEach(notification => {
                            html += `<li class="notification-item" title="${notification.message}">
                                <strong>${notification.title}</strong>
                                <small class="text-muted d-block">${new Date(notification.created_at).toLocaleDateString()}</small>
                            </li>`;
                        });
                        notificationsContainer.innerHTML = html;
                    } else {
                        notificationsContainer.innerHTML = '<li class="notification-item"><em>No new notifications</em></li>';
                    }
                })
                .catch(error => {
                    console.error('Notifications error:', error);
                    notificationsContainer.innerHTML = '<li class="notification-item"><em>Unable to load notifications</em></li>';
                });
        {% else %}
            notificationsContainer.innerHTML = '<li class="notification-item"><em>Log in to see your notifications</em></li>';
        {% endif %}
    }

    // Initial loads
    loadBlogFeed();
    loadNotifications();
</script>
{% endblock %}

